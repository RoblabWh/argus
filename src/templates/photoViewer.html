<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>photo viewer</title>
    <style>
    .mySlides {
      display: none;
      width:100%;
    }

    #slideshow-container {
      width: 100%;
      position: relative;
      margin: auto;
    }

    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      width: auto;
      padding: 16px;
      margin-top: -22px;
      color: white;
      font-weight: bold;
      font-size: 32px;
      transition: 0.3s ease;
      user-select: none;
      background-color: rgba(1,1,1,0.4);
      border-radius: 4px;
      z-index: 10;
    }
    .next {
      right: 0;
    }

    .prev:hover, .next:hover {
      color: white;
      background-color: rgb(56, 152, 236);
    }


    .img-magnifier-glass {
      position: absolute;
      z-index: 3;
      border: 3px solid #000;
      border-radius: 4px;
      cursor: none;
      /*Set the size of the magnifier glass:*/
      width: 250px;
      height: 250px;
      opacity:0;
      pointer-events:none;
    }

    .img-magnifier-hide {
      display: none
    }

    a:hover .img-magnifier-glass {
      opacity:1;
      pointer-events:initial;
    }


    .ir-overlay{
        z-index: 2;
        opacity: 0;
    }

    .temp-glass {
        position: absolute;
        background-color: #ffffff;
        padding: 5px;
        opacity: 0;
        z-index: 20;
    }

    #temp-glass p {
        margin: 0px;
    }


    .ir-overlay:hover .temp-glass{
        opacity: 1;
    }


    #grad1 {
      height: 100%;
      background-color: purple;
      background-image: linear-gradient(to right, black, darkblue, purple ,red,orange, yellow, white);
      width: 100%;
    }


    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 5px;
      background: lightgrey;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider:hover {
      opacity: 1;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgb(56, 152, 236);
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgb(56, 152, 236);
      cursor: pointer;
    }

    .container{
        width: 100%;
        margin: 0 auto;
        margin-top: 20px;
        margin-bottom: 20px
    }

    ul.tabs{
        margin: 0px;
        padding: 0px;
        list-style: none;

    }
    ul.tabs li{
        background: rgb(56, 152, 236);
        color: white;
        display: inline-block;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
    }

    #tab-link-1{
        border-top-left-radius: 6px;
        {% if not has_ir %}
        border-top-right-radius: 6px;
        {% endif %}
    }

    #tab-link-2{
        border-top-right-radius: 6px;
    }

    ul.tabs li:hover{
        background rgb(56, 152, 236);
    }

    ul.tabs li.current{
        background: #cecece;
        color: black;
    }

    .tab-content_gallery{
        overflow: auto;
        display: none;
        background: #cecece;
        padding: 20px;
        border-ne: 3px solid rgb(56, 152, 236);
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .tab-content_gallery.current{
        display: inherit;
    }


    .slideshow-settings-container {;
        width-no:100%;
        min-width: 535px;
        margin: auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto;

        padding: 20px;
        column-gap: 5px;
        row-gap: 0px;

        background-color:white;
        border-radius: 6px;
        margin-bottom: 10px;
        justify-self: start;
    }

    .slideshow-settings-item {
        width: 90%;
        justify-self: start;
        margin: 0 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        grid-template-rows: auto;
        grid-template-areas:
            "a0 a0 a0 a0"
            "b0 b0 b0 b1"
            "c0 c0 c0 c0"
            "d0 d1 d1 d1"
            "e0 e1 e2 e3";
        gap: 5px 5px;
        margin-top: 0px;
        border: lightgrey 1px solid;
        padding: 10px;
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
    }

    .slideshow-settings-title{
        margin: 8px 0;
        margin-top: 0px;
        background-color: #dbdbdb;
        border-radius: 6px;
        margin-bottom: 0px;
        padding-bottom: 0px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        width: 90%;
        padding: 10px;
        border: lightgrey 1px solid;
    }

    .slideshow-settings-item > div {
        justify-self: start;
        width: 100%;
    }

    .setting-fade {
        opacity: 1.0;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 30px;
      height: 17px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgb(150, 80, 80);;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .switch-slider:before {
      position: absolute;
      content: "";
      height: 13px;
      width: 13px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .switch-slider {
      background-color: #2196F3;
    }

    input:focus + .switch-slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .switch-slider:before {
      -webkit-transform: translateX(13px);
      -ms-transform: translateX(13px);
      transform: translateX(13px);
    }

    .switch-slider.round {
      border-radius: 17px;
    }

    .switch-slider.round:before {
      border-radius: 50%;
    }

</style>


<script>
    var displayingIR = false;

    function plusSlides(n) {
      slideIndex += n;
      var slides = document.getElementsByClassName("mySlides");
      if(slideIndex >= slides.length){
        slideIndex = 0;
      } else if (slideIndex < 0){
        slideIndex = slides.length - 1;
      }
      showCurrentSlide();
    }

    function showSlideByID(id) {
        console.log(id);
        var i;
        var slides = document.getElementsByClassName("mySlides");
        console.log(slides.findIndex(x => x.id === id));
        for (i = 0; i < slides.length; i++) {
            console.log(slides[i].id +id);
            if (slides[i].id === id) {
                showSlide(i);
                break;
            }
        }
    }

    function showSlide(n) {
      slideshowContainer.scrollIntoView({
          behavior: "smooth",
          block: "start",
          inline: "nearest"
      });
      console.log(n);
      slideIndex = n
      if(displayingIR){
        deactivateIR();
      }
      displayingIR = false;
      showCurrentSlide();
    }

    function showSlideIR(n) {
      slideshowContainer.scrollIntoView({
          behavior: "smooth",
          block: "start",
          inline: "nearest"
      });
      console.log(n);
      slideIndex = n
      activateIR();
      showCurrentSlide();
    }

    function showCurrentSlide() {
      {% if has_ir %}
      currentIROpacity = document.getElementById("irOpacityRange").value/100;
      applyOpacity(currentIROpacity);//checkIR();
      {% endif %}
      checkbox = document.getElementById("magnifierCheckbox");
      demagnify();
      console.log(slideIndex);
      var i;
      var x = document.getElementsByClassName("mySlides");
      console.log(x);
      if (slideIndex >= x.length) {slideIndex = 0}
      if (slideIndex < 0) {slideIndex = x.length-1}
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      x[slideIndex].style.display = "block";
      zoomValue = document.getElementById("zoomRange").value/10;
      if(checkbox.checked){
        magnify(slideIndex, zoomValue);
      }
    }

    function checkIR() {
        if(displayingIR){
            var divsToHide = document.getElementsByClassName("ir-overlay"); //divsToHide is an array
            if(divsToHide[0].style.display == 0){
                for(var i = 0; i < divsToHide.length; i++){
                    divsToHide[i].style.opacity = 1; // depending on what you're doing
                }
            }
        } else {
            var divsToShow = document.getElementsByClassName("ir-overlay"); //divsToHide is an array
            if(divsToShow.length == 0){
                return; // no IR images
            }
            if(divsToShow[0].style.opacity > 0){
                for(var i = 0; i < divsToShow.length; i++){
                    divsToShow[i].style.opacity = 0; // depending on what you're doing
                }
            }
        }
    }

    function applyOpacity(irOpacity) {
        var irSlides = document.getElementsByClassName("ir-overlay");
        if(irSlides.length == 0){
            return; // no IR images
        }

        var currentIRSlide = document.getElementsByClassName("ir-overlay")[slideIndex];
        if(displayingIR){
            //var currentIRSlideOpacity = document.getElementById("irOpacityRange").value/100;
            currentIRSlide.style.opacity = irOpacity;
        }
        else{
            currentIRSlide.style.opacity = 0;
        }
    }



    // magnify hover
    function magnify(imgNbr, zoom) {
      var img, glass, w, h, bw;
      demagnify();
      //img = document.getElementById(imgID);
      img = document.getElementsByClassName("mySlides")[imgNbr].getElementsByTagName('a')[1].getElementsByTagName('img')[0];
      /*create magnifier glass:*/
      glass = document.createElement("DIV");
      glass.setAttribute("class", "img-magnifier-glass");
      glass.setAttribute("id", "magnifying-glass-id-for-deleting");
      /*insert magnifier glass:*/
      img.parentElement.insertBefore(glass, img);
      /*set background properties for the magnifier glass:*/
      glass.style.backgroundImage = "url('" + img.src + "')";
      glass.style.backgroundRepeat = "no-repeat";
      console.log(img.width + " " + img.height);
      glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
      bw = 3;
      w = glass.offsetWidth / 2;
      h = glass.offsetHeight / 2;
      /*execute a function when someone moves the magnifier glass over the image:*/
      glass.addEventListener("mousemove", moveMagnifier);
      img.addEventListener("mousemove", moveMagnifier);
      /*and also for touch screens:*/
      glass.addEventListener("touchmove", moveMagnifier);
      img.addEventListener("touchmove", moveMagnifier);
      function moveMagnifier(e) {
        var pos, x, y;
        /*prevent any other actions that may occur when moving over the image*/
        e.preventDefault();
        /*get the cursor's x and y positions:*/
        pos = getCursorPos(e);
        x = pos.x;
        y = pos.y;
        /*prevent the magnifier glass from being positioned outside the image:*/
        //if (x > img.width - (w / zoom)) {x = img.width - (w / zoom);}
        //if (x < w / zoom) {x = w / zoom;}
        //if (y > img.height - (h / zoom)) {y = img.height - (h / zoom);}
        //if (y < h / zoom) {y = h / zoom;}
        if (x > img.width - (w / zoom) || x < (w / zoom) || y > img.height - (h / zoom) || y < (h / zoom)) {
            glass.setAttribute("class", "img-magnifier-hide");
        } else {
            glass.setAttribute("class", "img-magnifier-glass");
        }
        /*set the position of the magnifier glass:*/
        glass.style.left = (x - w) + "px";
        glass.style.top = (y - h) + "px";
        /*display what the magnifier glass "sees":*/
        glass.style.backgroundPosition = "-" + ((x * zoom) - w + bw) + "px -" + ((y * zoom) - h + bw) + "px";
      }
      function getCursorPos(e) {
        var a, x = 0, y = 0;
        e = e || window.event;
        /*get the x and y positions of the image:*/
        a = img.getBoundingClientRect();
        /*calculate the cursor's x and y coordinates, relative to the image:*/
        x = e.pageX - a.left;
        y = e.pageY - a.top;
        /*consider any page scrolling:*/
        x = x - window.pageXOffset;
        y = y - window.pageYOffset;
        return {x : x, y : y};
      }
      }

      function demagnify() {
        glass = document.getElementById("magnifying-glass-id-for-deleting");
        if(glass){
            glass.parentNode.removeChild(glass);
            }
      }


</script>
</head>
<body>

<div id="slideshow-container">
    <a class="prev" onclick="plusSlides(-1)">❮</a>
    <a class="next" onclick="plusSlides(1)">❯</a>
    {% if file_names %}
    {% for filename in file_names %}
    <div class="mySlides">
        <a>{{filename.split('/')[-1]}}</a>
        {% if has_ir %}
        <div style="margin-bottom:7%;"></div>
        <div style="position: relative;">
            <div style="position: absolute; top: -10%; left: 0px;">
                <a><img src="{{ url_for('static', filename=filename) }}" style="width:100%; height: 100%;"></a>
            </div>
            <div class="ir-overlay" style="position: relative; top: 0; left: 10%; width:80%; height:80%">
<!--                <canvas style="width:100%; height: 100%;" id="canvas{{loop.index0}}"></canvas>-->
                <img class="ir-image" id="image{{loop.index0}}" src="{{ url_for('static', filename=file_names_ir[loop.index0]) }}" style="width:100%; height: 100%;">
                <div class="temp-glass" id="temp-glass{{loop.index0}}"> <p>Temp:</p></div>

            </div>
        </div>
        <div style="margin-bottom: 10%;"></div>

        {% else %}
        <a><img src="{{ url_for('static', filename=filename) }}" style="width:100%; height: 100%;"></a>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

</div>

<div class="slideshow-settings-container">
    <h3 class="slideshow-settings-title">Slideshow Settings RGB</h3>
    {% if has_ir %}
    <h3 class="slideshow-settings-title">Slideshow Settings IR</h3>
    {% else %}
    <h3>   </h3>
    {% endif %}
    <div id="slideshow-settings-RGB" class="slideshow-settings-item">
        <div style="grid-area: a0;">
            <label>
                <label class="switch">
                    <input type="checkbox" id="magnifierCheckbox" checked="checked">
                    <span class="switch-slider round"></span>
                </label>
              Magnifier
            </label>
        </div>
        <div style="grid-area: b0;">
            <input type="range" min="10" max="100" value="50" class="slider" id="zoomRange" style="width:100%;">
        </div>
        <div style="grid-area: b1;">
             <label for="zoomRange" >Zoom: <span id="zoomValue"></span></label>
        </div>
        <div style="grid-area: c0; display: inline-block;"></div>
        <div style="grid-area: d0;"></div>
    </div>
    {% if has_ir %}
    <div id="slideshow-settings-IR" class="slideshow-settings-item">
        <div style="grid-area: a0;">
            <label>
                <label class="switch">
                    <input type="checkbox" id="irOverlayCheckbox">
                    <span class="switch-slider round"></span>
                </label>
              Infrared image overlay
            </label>
        </div>
        <div class="setting-fade" style="grid-area: b0;">
            <input type="range" min="10" max="100" value="100" class="slider setting-disabler" id="irOpacityRange" style="width:100%; grid-area: center">
        </div>
        <div class="setting-fade" style="grid-area: b1;">
            <label for="irOpacityRange" >Opacity: <span id="opacityValue"></span></label>
        </div>
        <div class="setting-fade" style="grid-area: c0;">
            <label>
                <label class="switch">
                    <input class="setting-disabler" type="checkbox" id="temperatureCheckbox">
                    <span class="switch-slider round"></span>
                </label>
                Read temperature
            </label>
        </div>
        <div class="setting-fade" style="grid-area: d0;">
            <select class="setting-disabler" style="width: 100%">
                <option>blargh</option>
                <option>blargh2</option>
            </select>
        </div>
        <div class="setting-fade" style="grid-area: d1;" id="grad1"></div>
        <div class="setting-fade" style="grid-area: e0;">
            <input class="setting-disabler" type="number" id="minTemp" name="minTemp" min="-20" max="800" value="20"
                   style="width: 90%; padding; 0px: height:100%; border: 0px; border-radius: 4px;">
        </div>
        <div class="setting-fade" style="grid-area: e1;">min</div>
        <div class="setting-fade" style="grid-area: e2;">
            <input class="setting-disabler" type="number" id="maxTemp" name=maxnTemp" min="-20" max="800" value="20"
                   style="width: 90%; padding; 0px: height:100%; border: 0px; border-radius: 4px;">
        </div>
        <div class="setting-fade" style="grid-area: e3;">max</div>
    </div>
    {% endif %}
</div>

    <div class="container">

        <ul class="tabs">
            <li id="tab-link-1" class="tab-link current" data-tab="tab-1">RGB Photos</li>
            {% if has_ir %}
            <li id="tab-link-2" class="tab-link" data-tab="tab-2"> IR Photos</li>
            {% endif %}
        </ul>

        <div id="tab-1" class="tab-content_gallery current">
            {% if file_names %}
            {% for filename in file_names %}
            <div style="float:left;width:20%; min-width:240px;">
                <img src="{{ url_for('static', filename=filename) }}" style="padding: 5px;width:95%;cursor: pointer;" onclick="showSlide({{loop.index0}})">
            </div>
            {% endfor %}
            {% endif %}
        </div>
        <div id="tab-2" class="tab-content_gallery">
            <div style="width: 100%; height: 100%; overflow: auto;">
                {% if file_names_ir %}
                {% for filename in file_names_ir %}
                <div style="float:left;width:20%; min-width:240px;">
                    <img src="{{ url_for('static', filename=filename) }}" style="padding: 5px;width:95%;cursor: pointer;" onclick="showSlideIR({{loop.index0}})">
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>

    </div>

<script>
    function getPosition(obj) {
        var curleft = 0,
        curtop = 0;
        if (obj.offsetParent) {
            do {
                curleft += obj.offsetLeft;
                curtop += obj.offsetTop;
            } while (obj = obj.offsetParent);
            return {
                x: curleft,
                y: curtop
            };
        }
        return undefined;
    }

    function rgbToHex(r, g, b) {
        if (r > 255 || g > 255 || b > 255)
            throw "Invalid color component";
        return ((r << 16) | (g << 8) | b).toString(16);
    }

</script>



<script>

    var slideIndex = 0;
    showCurrentSlide(slideIndex);
    var slideshowContainer = document.getElementById("slideshow-container");


    var checkbox = document.getElementById("magnifierCheckbox");
    var slider = document.getElementById("zoomRange");
    var output = document.getElementById("zoomValue");
    //document.getElementById("zoomValue").innerHTML = slider.value/10;
    output.innerHTML = slider.value;

    document.getElementsByClassName("mySlides")[0].getElementsByTagName('a')[1].getElementsByTagName('img')[0].onload = function(){
        magnify(0,slider.value/10);
    }

    slider.oninput = function() {
      output.innerHTML = this.value/10;
      demagnify();
      if(checkbox.checked){
        magnify(slideIndex, this.value/10);
      }
    }


    checkbox.onchange = function() {
        if(this.checked){
            magnify(slideIndex, slider.value/10);
        }else{
            demagnify();
        }
    }

    output.innerHTML = slider.value/10;

    $(document).ready(function(){
        $('ul.tabs li').click(function(){
            var tab_id = $(this).attr('data-tab');

            $('ul.tabs li').removeClass('current');
            $('.tab-content_gallery').removeClass('current');

            $(this).addClass('current');
            $("#"+tab_id).addClass('current');
        })

        $('#irOverlayCheckbox').change(function(){
            if(this.checked){
                $('#magnifierCheckbox').prop('checked', false);
                demagnify();
                displayingIR = true;
                showCurrentSlide();
                $('.setting-fade').map(function () {
                    $(this).css("opacity", "0.999");
                });
                $('.setting-disabler').map(function () {
                    $(this).prop('disabled', false);
                });
            }else{
                $('#magnifierCheckbox').prop('checked', true);
                displayingIR = false;
                showCurrentSlide(slideIndex);
                $('.setting-fade').map(function () {
                    $(this).css("opacity", "0.4");
                });
                $('.setting-disabler').map(function () {
                    $(this).prop('disabled', true);
                });
            }
        });

        $('#magnifierCheckbox').change(function(){
            if(this.checked){
                $('#irOverlayCheckbox').prop('checked', false);
                displayingIR = false;
                showCurrentSlide(slideIndex);
            }else{
                //$('#irOverlayCheckbox').prop('checked', true);
                demagnify();
                //displayingIR = true;
                //showCurrentSlide();
            }
        });



    })
    {% if has_ir %}

    $('#irOpacityRange').change(function(event) {
        irOpacity = document.querySelector('#irOpacityRange').value/100;
        applyOpacity(irOpacity);
        opacityValue = document.querySelector('#opacityValue');
        opacityValue.innerHTML = irOpacity;
    });





    $('#irOverlayCheckbox').prop('checked', false);
    $('#magnifierCheckbox').prop('checked', true);
    $('.setting-fade').map(function () {
        $(this).css("opacity", "0.4");
    });
    $('.setting-disabler').map(function () {
        $(this).prop('disabled', true);
    });


    function activateIR() {
        displayingIR = true;
        $('#irOverlayCheckbox').prop('checked', true);
        $('#magnifierCheckbox').prop('checked', false);
        $('.setting-fade').map(function () {
            $(this).css("opacity", "0.999");
        });
        $('.setting-disabler').map(function () {
            $(this).prop('disabled', false);
        });
        showCurrentSlide(slideIndex);
    }

     function deactivateIR() {
        displaying = true;
        $('#irOverlayCheckbox').prop('checked', false);
        $('#magnifierCheckbox').prop('checked', true);
        $('.setting-fade').map(function () {
            $(this).css("opacity", "0.4");
        });
        $('.setting-disabler').map(function () {
            $(this).prop('disabled', true);
        });
    }

    $('#irOpacityRange').val(100);
    $('#irOpacityRange').change();

    window.onload = function() {
        {% for filename_ir in file_names_ir %}
        var img = document.getElementById('image{{loop.index0}}');
            img.addEventListener("mousemove", function(e) {
                if($('#temperatureCheckbox').is(':checked')){

                    var img = document.getElementById('image{{loop.index0}}');
                    var canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height);
                    var p = canvas.getContext('2d').getImageData(e.offsetX, e.offsetY, 1, 1).data;
                    var coord = "x: " + e.offsetX + " ,y: " + e.offsetY;
                    // If transparency on the image
                    if ((p[0] == 0) && (p[1] == 0) && (p[2] == 0) && (p[3] == 0)) {
                        coord += " (Transparent color detected, cannot be converted to HEX)";
                    }
                    var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);

                    document.getElementById("temp-glass{{ loop.index0 }}").style.backgroundColor = hex;
                    document.getElementById("temp-glass{{ loop.index0 }}").innerHTML = coord + p[0] + p[1] + p[2] + p[3];

                    $('#temp-glass{{ loop.index0 }}').css({
                        left: e.offsetX + 20,
                        top: e.offsetY + document.body.scrollTop
                    });
                    if ((p[0]*0.299 + p[1]*0.587 + p[3]*0.114) > 186){
                        document.getElementById("temp-glass{{ loop.index0 }}").style.color = "#000000";
                    } else {
                        document.getElementById("temp-glass{{ loop.index0 }}").style.color = "#ffffff";
                    }
                 } else {
                    document.getElementById("temp-glass{{ loop.index0 }}").style.backgroundColor = "transparent";
                    document.getElementById("temp-glass{{ loop.index0 }}").innerHTML = "";
                 }

            });
        {% endfor %}
    };



    {% endif %}



</script>
</body>
</html>