<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>photo viewer</title>
    <style>
    .mySlides {
      display: none;
      width:100%;
    }

    #slideshow-container {
      width: 100%;
      position: relative;
      margin: auto;
    }

    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      width: auto;
      padding: 16px;
      margin-top: -22px;
      color: white;
      font-weight: bold;
      font-size: 32px;
      transition: 0.3s ease;
      user-select: none;
      background-color: rgba(1,1,1,0.4);
      border-radius: 4px;
      z-index: 10;
    }
    .next {
      right: 0;
    }

    .prev:hover, .next:hover {
      color: var(--font-color-b);
      background-color: var(--accent-color-interaction);
    }

    .dynamic-images-rgb {
        width: 100%;
        height: 100%;
    }

    .ir-image{
        width:100%;
        height: 100%;
    }

    .img-magnifier-glass {
      position: absolute;
      z-index: 300;
      border: 3px solid #000;
      border-radius: 4px;
      cursor: none;
      /*Set the size of the magnifier glass:*/
      width: 250px;
      height: 250px;
      opacity:1;
      pointer-events:initial;
    }

    .img-magnifier-hide {
      display: none
    }




    .ir-overlay{
        z-index: 2;
        opacity: 0;
    }

    .temp-glass {
        position: absolute;
        background-color: #ffffff;
        padding: 5px;
        opacity: 0;
        z-index: 99;
        border-radius: 4px;
        border-style: solid;
        border-width: 2px;
    }

    #temp-glass p {
        margin: 0px;
    }


    .ir-overlay:hover .temp-glass{
        //opacity: 1;
    }


    #grad {
      height: 100%;
      background-color: purple;
      width: 100%;
    }

    .grad-option1{
          background-image: linear-gradient(to right, black, white);
    }

    .grad-option2{
          background-image: linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(255,0,0,1) 37.5%, rgba(255,255,0,1) 75%,
          rgba(255,255,255,1) 100%);
    }

    .grad-option3{
          background-image:  linear-gradient(90deg, rgba(0,0,32,1) 0%, rgba(32,0,96,1) 12.5%, rgba(181,0,164,1) 37.5%,
          rgba(255,64,0,1) 50%, rgba(255,255,0,1) 87.5%, rgba(255,255,200,1) 100%);
    }

    .grad-option4{
          background-image:  linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(30,129,129,1) 35%, rgba(255,255,0,1) 75%,
          rgba(255,65,0,1) 93.5%, rgba(225,0,0,1) 100%);
    }


    .grad-option5{
          background-image: linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(221,60,221,1) 12.5%, rgba(32,32,255,1) 25%,
           rgba(19,240,240,1) 37.5%, rgba(0,160,0,1) 55%, rgba(224,231,14,1) 70%, rgba(255,255,19,1) 75%,
           rgba(255,32,32,1) 87.5%, rgba(255,255,255,1) 100%);
    }


    .grad-option6{
          background-image: linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(0,64,255,1) 12.5%, rgba(0,160,60,1) 25%,
          rgba(128,255,0,1) 37.5%, rgba(255,255,0,1) 50%, rgba(255,0,0,1) 75%, rgba(255,0,255,1) 87.5%,
          rgba(255,255,255,1) 100%);
    }


    .grad-option7{
          background-image: linear-gradient(90deg, rgba(127,0,0,1) 0%, rgba(255,0,193,1) 12.5%, rgba(207,0,255,1) 16.5%,
          rgba(0,0,255,1) 33%, rgba(0,255,255,1) 50%, rgba(0,255,0,1) 66%,rgba(255,255,0,1) 82.5%, rgba(255,0,0,1) 100%);
    }


    .grad-option8{
          background-image: linear-gradient(90deg, rgba(0,0,128,1) 0%, rgba(0,0,255,1) 12.5%, rgba(0,255,255,1) 37.5%,
          rgba(255,255,0,1) 62.5%, rgba(255,0,0,1) 87.5%, rgba(128,0,0,1) 100%);
    }


    .grad-option9{
          background-image:  linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(255,255,255,1) 70%, rgba(255,98,98,1) 87.5%,
          rgba(222,0,0,1) 100%);
    }

    .grad-option10{
        background-image:  linear-gradient(to right, white, black);
    }



    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 5px;
      background: white;
      outline: none;
      opacity: 1;
      -webkit-transition: .2s;
      transition: .2s;
    }


    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-color-interaction);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-color-interaction);
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb:hover {
      border: 2px solid var(--accent-color-interaction);
    }
    .slider::-moz-range-thumb:hover {
      border: 2px solid var(--accent-color-interaction);
    }

    .container{
        width: 100%;
        margin: 0 auto;
        margin-top: 20px;
        margin-bottom: 20px
    }

    ul.tabs{
        margin: 0px;
        padding: 0px;
        list-style: none;
    }


    ul.tabs li{
        background: var(--accent-color-interaction);
        color: var(--font-color-b);
        display: inline-block;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    ul.tabs li:hover{
        color: var(--font-color-a);
    }

    #tab-link-1{
        border-top-left-radius: 6px;
        {% if not has_ir and not panos and not unprocessed_images %}
        border-top-right-radius: 6px;
        {% endif %}
    }

    #tab-link-2{
        {% if not has_rgb %}
        border-top-left-radius: 6px;
        {% endif %}
        {% if not panos and not unprocessed_images %}
        border-top-right-radius: 6px;
        {% endif %}
    }

    #tab-link-3{
        {% if not unprocessed_images %}
        border-top-right-radius: 6px;
        {% endif %}
    }

    #tab-link-4{
        border-top-right-radius: 6px;
        {% if not has_ir and not panos and not has_rgb %}
        border-top-left-radius: 6px;
        {% endif %}
    }

    ul.tabs li:hover{
        background var(--accent-color-interaction);
    }

    ul.tabs li.current{
        background: var(--bg-color-a);
        color: var(--font-color-a);
    }

    .tab-content_gallery{
        overflow: auto;
        display: none;
        background: var(--bg-color-a);
        padding: 20px;
        border-ne: 3px solid var(--accent-color-interaction);
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .tab-content_gallery.current{
        display: inherit;
    }


    .slideshow-settings-container {
        width-no:100%;
        min-width: 300px;
        margin: auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto;

        padding: 20px;
        column-gap: 5px;
        row-gap: 0px;

        background-color: var(--bg-color-page);
        border-radius: 6px;
        margin-bottom: 10px;
        justify-self: start;
    }

    .slideshow-settings-item {
        overflow: hidden;
        justify-self: start;
        margin: 0 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: auto;
        grid-template-areas:
            "a0 a1 a1"
            "b0 b1 b1"
            "c0 c0 c0";
        gap: 5px 5px;
        margin-top: 0px;
        padding: 16px;
    }

    .slideshow-settings-item-unstructured {
        overflow: hidden;
        justify-self: start;
        margin: 0 0 auto;
        margin-top: 0px;
        padding: 16px;
    }

    .slideshow-settings-item table {
        oveflow: hidden;
    }

    .slideshow-settings-title{
        margin: 8px 0;
        margin-top: 0px;
        background-color: #dbdbdb;
        border-radius: 6px;
        margin-bottom: 0px;
        padding-bottom: 0px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        width: 90%;
        padding: 10px;
        border: var(--bg-color-a) 1px solid;
    }

    .slideshow-settings-item > div {
        justify-self: start;
        width: 100%;
    }

    .slideshow-settings-inside-contianer{
        background-color: var(--bg-color-page);
        color: var(--font-color-a);
        border-radius: 6px;
        padding: 6px;
    }

    .setting-fade {
        opacity: 1.0;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 30px;
      height: 17px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--accent-color-red);
      -webkit-transition: .4s;
      transition: .4s;
    }

    .switch-slider:before {
      position: absolute;
      content: "";
      height: 13px;
      width: 13px;
      left: 2px;
      bottom: 2px;
      background-color: var(--bg-color-page);
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .switch-slider {
      background-color: var(--accent-color-interaction);
    }

    input:focus + .switch-slider {
      box-shadow: 0 0 1px var(--accent-color-interaction);
    }

    input:checked + .switch-slider:before {
      -webkit-transform: translateX(13px);
      -ms-transform: translateX(13px);
      transform: translateX(13px);
    }

    .switch-slider.round {
      border-radius: 17px;
    }

    .switch-slider.round:before {
      border-radius: 50%;
    }


    .tab-vertical {
        float: left;
        width: 20%;
        margin-right: 8px;
    }

    /* Style the buttons inside the tab */
    .tab-vertical button {
        display: block;
        background-color: var(--accent-color-interaction);
        color: var(--font-color-b);
        padding: 12px 6px;
        margin-top: 0px;
        margin-bottom: 10px;
        width: 100%;
        border-style: solid;
        border-width: 2px;
        border-color: var(--accent-color-interaction);
        outline: none;
        text-align: left;
        cursor: pointer;
        transition: 0.3s;
        font-size: 17px;
        border-radius: 6px;
    }

    /* Change background color of buttons on hover */
    .tab-vertical button:hover {
        font-weight: bold;
        color: var(--font-color-a);
    }

    /* Create an active/current "tab button" class */
    .tab-vertical button.active {
        background-color: var(--bg-color-a);
        color: var(--font-color-a);
        font-weight: bold;
        border-style: solid;
        border-width: 2px;
        border-color: var(--accent-color-interaction);
    }

    /* Style the tab content */
    .tabcontent-vertical {
        padding: 0px 12px;
        background-color: var(--bg-color-a);
        border-radius: 6px;
        float: none;
        overflow: hidden;
        border-left: none;
        min-height: 120px;
        width: 100%;
        margin-bottom: auto;
    }

    #slideshow-settings-tabs{
        display: flex;
        width: 100%;
        box-sizing: border-box;
        margin: 20px 0;
    }

   #layer-table-container{
        background-color: var(--bg-color-page);//rgb(66,66,66);
        color: var(--font-color-a);
        border-radius: 6px;
        padding: 6px;
    }

    #layer-table-container td, th {
        border: 0px solid;
        text-align: left;
        padding: 8px;
    }

    #layer-table-container tr {
        background-color: var(--bg-color-AILayer);
    }
    #layer-table-container tr:nth-child(even) {
        background-color: var(--bg-color-AILayer);
    }
    #layer-table-container tr:nth-child(1) {
        background-color: transparent;
        border-bottom: 2px solid var(--bg-color-a);
    }

    .usedInMappingContainer{
        display: inline-block;
        float: right;
        margin: 0 12px 12px 12px;
        min-width: 25%;
    }

    .usedInMapping, .notUsedInMapping{
        border-radius: 6px;
        border-style: solid;
        border-width: 2px;
        height: 100%;
        width: 100%;
        padding: 4px;
    }

    .usedInMapping{
        border-color: var(--accent-color-green);
        background-color: rgba(var(--accent-color-green-values), 0.2);
        color: var(--font-color-a);
        display: flex;
    }

    .notUsedInMapping{
        border-color: var(--accent-color-red);
        background-color: rgba(var(--accent-color-red-values), 0.2);
        color: var(--font-color-a);
        display: none;
    }


    .range_container {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin: 16px auto;
    }

    .sliders_control {
        position: relative;
        min-height: 30px;
    }


    .sliders_control input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        pointer-events: all;
        width: 11px;
        height: 24px;
        cursor: pointer;
        background-color: var(--accent-color-interaction);
        z-index: 10;
    }

    .sliders_control input[type=range]::-moz-range-thumb {
        -webkit-appearance: none;
        pointer-events: all;
        width: 11px;
        height: 24px;
        cursor: pointer;
        background-color: var(--accent-color-interaction);
        z-index: 10;
    }

    .sliders_control input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 20px;
        width: 100%;
        position: absolute;
        background-color: #C6C6C6;
        pointer-events: none;
        z-index: 4;
    }

    #fromSlider{
        z-index: 10;
        background: rgba(0,0,0,0);
    }

    #toSlider{
        z-index: 10;
    }



    .bubble {
        background: var(--bg-color-b);
        color: var(--font-color-b);
        padding: 4px 12px;
        position: absolute;
        border-radius: 4px;
        left: 50%;
        top: 26px;
        transform: translateX(-50%);
    }
    .bubble::after {
        content: "";
        position: absolute;
        width: 2px;
        height: 2px;
        background: var(--bg-color-b);
        top: -1px;
        left: 50%;
    }


</style>

<script>


    

    function plusSlides(n) {
      slideIndex += n;
      console.log("slideIndex: " + slideIndex + " slideshowCouples.length: " + slideshowCouples.length + " n: " + n);
      if(slideIndex >= slideshowCouples.length){
        slideIndex = 0;
      } else if (slideIndex < 0){
        slideIndex = slideshowCouples.length - 1;
      }
      console.log(slideIndex);
      if(displayingIR){
        if(slideshowCouples[slideIndex][1] == ""){
          plusSlides(n);
        }
        else{
          showCurrentSlide();
        }
      } else {
        if(slideshowCouples[slideIndex][0] == "" && slideshowCouples[slideIndex][2] == null){
          plusSlides(n);
        }
        else{
          showCurrentSlide();
        }
      }
    }



    function showSlideByFilename(filename){
        console.log("showSlideByFilename: " + filename);
        
        //check if filename is full path or only filename
        if (!filename.includes("./static/")){
            showSlideByShortFilename(filename);
            return;
        }

        var slideIndex = getSlideIndexByFilename(filename, 0);
        if (slideIndex == -1){
            slideIndex = getSlideIndexByFilename(filename, 1);
        }
        if (slideIndex == -1){
            slideIndex = getSlideIndexByFilename(filename, 2);
        }
        if(slideIndex != -1){
            showSlide(slideIndex);
        } else{
            console.log("No slide found for filename: " + filename);   
        }
    }

    function showSlideByShortFilename(filename){
        console.log("showSlideByShortFilename: " + filename);

        var slideIndex = getSlideIndexByFilenameShort(filename, 0);
        if (slideIndex == -1){
            slideIndex = getSlideIndexByFilenameShort(filename, 1);
        }
        if (slideIndex == -1){
            slideIndex = getSlideIndexByFilenameShort(filename, 2);
        }
        if(slideIndex != -1){
            showSlide(slideIndex);
        } else{
            console.log("No slide found for filename: " + filename);   
        }
    }


    function showSlideByFilenameIR(filename){
        console.log("showSlideByFilenameIR: " + filename);
        var slideIndex = getSlideIndexByFilename(filename, 1);
        if(slideIndex != -1){
            showSlideIR(slideIndex);
        }
    }


    function showSlide(n) {
        console.log("showSlide: " + n);
        if(n >= slideshowCouples.length){
            n = 0;
        } else if (n < 0){
            n = slideshowCouples.length - 1;
        }
        console.log(n);
        slideIndex = n


        var details = document.getElementById("gallery-details");
        if(!details.open){
            details.open = true;
        }
        slideshowContainer.scrollIntoView({
            behavior: "smooth",
            block: "start",
            inline: "nearest"
        });


        if(displayingIR){
            deactivateIR();
        }
        displayingIR = false;
        showCurrentSlide();
    }


    function showSlideIR(n) {
        var details = document.getElementById("gallery-details");
        if(!details.open){
            details.open = true;
        }
        slideshowContainer.scrollIntoView({
            behavior: "smooth",
            block: "start",
            inline: "nearest"
        });
        if(n >= slideshowCouples.length){
            n = 0;
        } else if (n < 0){
            n = slideshowCouples.length - 1;
        }
        console.log(n);
        slideIndex = n
        activateIR();
        showCurrentSlide();
    }


    function showCurrentSlide() {
        var details = document.getElementById("gallery-details");
        if(!details.open){
            details.open = true;
        }


        demagnify();
        //console.log(slideIndex);

        dynamicCanvas = document.getElementById("dynamic-canvas");

        currentImageName = slideshowCouples[slideIndex][0].substring(slideshowCouples[slideIndex][0].lastIndexOf('/') + 1);
        dynamicFilename = document.getElementById("dynamic-filename-RGB");
        dynamicFilename.innerHTML = "RGB: " + currentImageName;

        currentImageNameIR = slideshowCouples[slideIndex][1].substring(slideshowCouples[slideIndex][1].lastIndexOf('/') + 1);
        dynamicFilenameIR = document.getElementById("dynamic-filename-IR");
        dynamicFilenameIR.innerHTML = "IR: " + currentImageNameIR;

        dynamicFilenameUnprocessed = document.getElementById("dynamic-filename-Unprocessed");
        dynamicFilenameUnprocessed.innerHTML = "Unprocessed: ";
        try{
            currentImageNameUnprocessed = slideshowCouples[slideIndex][2].substring(slideshowCouples[slideIndex][0].lastIndexOf('/') + 1);
            dynamicFilenameUnprocessed.innerHTML = "Unprocessed: " + currentImageNameUnprocessed;
        }
        catch(err){
            console.log("No unprocessed image");
        }
        if(dynamicFilenameUnprocessed.innerHTML != "Unprocessed: "){
            dynamicFilenameUnprocessed.style.display = "inline-block";
            dynamicFilename.style.display = "none";
            dynamicFilenameIR.style.display = "none";
        }
        else{
            dynamicFilenameUnprocessed.style.display = "none";
            dynamicFilename.style.display = "inline-block";
            dynamicFilenameIR.style.display = "inline-block";
        }

        imageRGB = allImages[slideIndex][0];
        imageUnprocessed = allImages[slideIndex][2];
        currentImagePaths = slideshowCouples[slideIndex];

        var noRGBImageOnShow = false;

        if(imageRGB == null){
            noRGBImageOnShow = true;
            if(currentImagePaths[0] != ""){
                imageRGB = new Image();
                imageRGB.onload = () => {
                    //width of div of class container
                    var body_width = document.getElementsByClassName("container")[0].offsetWidth;
                    //dynamicCanvas.width = body_width;
                    //dynamicCanvas.height = imageRGB.height * ( body_width/ imageRGB.width);
                    dynamicAnnotationsCanvas.setWidth(body_width);
                    dynamicAnnotationsCanvas.setHeight(imageRGB.height * ( body_width/ imageRGB.width));
                    dynamicAnnotationsCanvas.renderAll()

                    if(displayingAI){
                        toggleLayerSettings(false);
                        drawAnnotationsOnCurrentSlide();
                    } else{
                        toggleLayerSettings(true);
                        removeAnnotations();
                    }

                    zoomValue = document.getElementById("zoomRange").value/10;
                    if(magnifiying){
                        magnify(slideIndex, zoomValue);
                    }
                };
                //TODO use global_for ?
                imageRGB.src = currentImagePaths[0];
                imageRGB.classList.add("dynamic-images-rgb");
                allImages[slideIndex][0] = imageRGB;
            }
            else{
                imageRGB = ImageRGB_missingCounterpart;
            }
        }


        if(imageUnprocessed == null){
            if(currentImagePaths[2] != "" && currentImagePaths[2] != null){
                imageUnprocessed = new Image();
                imageUnprocessed.src = currentImagePaths[2];
                allImages[slideIndex][2] = imageUnprocessed;
            }
        }


        a = document.getElementById("dynamic-image-RGB");
        while (a.firstChild) {
            a.removeChild(a.firstChild);
        }
        a.appendChild(imageRGB);

        {% if has_ir %}
        showCurrentSlideIR();
        {% endif %}



        zoomValue = document.getElementById("zoomRange").value/10;
        if(magnifiying){
            magnify(slideIndex, zoomValue);
        }

        {% if maps %}
        if(isUsedInMap(slideIndex, displayingIR)){
            details.getElementsByClassName("usedInMapping")[0].style.display = "flex";
            details.getElementsByClassName("notUsedInMapping")[0].style.display = "none";
        } else {
            details.getElementsByClassName("usedInMapping")[0].style.display = "none";
            details.getElementsByClassName("notUsedInMapping")[0].style.display = "flex";
        }
        {% endif %}

        if(lastSlide != slideIndex){
            if (detections != null){
                filenameOfSlide = getFilenameBySlideIndex(slideIndex, 0);
                generateAnnotationsLayerTableForImage(filenameOfSlide);
            }
        }

        if(displayingAI){
            toggleLayerSettings(false);
            if(!noRGBImageOnShow){
                drawAnnotationsOnCurrentSlide();
            }
        } else{
            toggleLayerSettings(true);
            removeAnnotations();
        }
        lastSlide = slideIndex;
    }

    function checkIR() {
        if(displayingIR){
            var divsToHide = document.getElementsByClassName("ir-overlay"); //divsToHide is an array
            if(divsToHide[0].style.display == 0){
                for(var i = 0; i < divsToHide.length; i++){
                    divsToHide[i].style.opacity = 1; // depending on what you're doing
                }
            }
        } else {
            var divsToShow = document.getElementsByClassName("ir-overlay"); //divsToHide is an array
            if(divsToShow.length == 0){
                return; // no IR images
            }
            if(divsToShow[0].style.opacity > 0){
                for(var i = 0; i < divsToShow.length; i++){
                    divsToShow[i].style.opacity = 0; // depending on what you're doing
                }
            }
        }
    }

    function applyOpacity(irOpacity) {

        var currentIRSlide = document.getElementById("dynamic-image-IR");
        if(displayingIR){
            //var currentIRSlideOpacity = document.getElementById("irOpacityRange").value/100;
            currentIRSlide.style.opacity = irOpacity;
        }
        else{
            currentIRSlide.style.opacity = 0;
        }
    }

    function showCurrentSlideIR() {

        // remove old images if there are some displayed
        div = document.getElementById("dynamic-image-IR");
        irImages = div.getElementsByClassName("ir-image");
        for (var i = 0; i < irImages.length; i++) {
            irImages[i].remove();
        }



        currentImagePaths = slideshowCouples[slideIndex];
        // get status of checkbox irModeCehckbox
        mode = document.getElementById("irModeCheckbox").checked;
        console.log("Ir analysis Mode: " + mode);

        if(!mode){
            imageIR = allImages[slideIndex][1];

            if(imageIR == null){
                if(currentImagePaths[1] != ""){
                    imageIR = new Image();
                    //TODO use global_for ?
                    imageIR.src = currentImagePaths[1];
                    imageIR.classList.add("ir-image");
                    allImages[slideIndex][1] = imageIR;

                }
                else{
                    imageIR = ImageIR_missingCounterpart;
                }
            }
            deactivateIRCanvas();
            div.insertBefore(imageIR, div.childNodes[0]);

        } else {
            let currentImageNameIRPath = slideshowCouples[slideIndex][1];
            loadImagesMatrix(currentImageNameIRPath);
            activateIRCanvas();
        }



        currentIROpacity = document.getElementById("irOpacityRange").value/100;
        applyOpacity(currentIROpacity);
    }



    // magnify hover
    function magnify(imgNbr, zoom) {
        var img, glass, w, h, bw, annotationCanvas;
        demagnify();

        img = document.getElementById("dynamic-slide").getElementsByTagName('img')[0];
        dynamicImageRGB = document.getElementById("dynamic-image-RGB");
        annotationCanvas = document.getElementById("dynamic-slide").getElementsByTagName('canvas')[0];
        allParent = dynamicImageRGB.parentNode.parentNode;

        /*create magnifier glass:*/
        glass = document.createElement("DIV");
        glass.setAttribute("class", "img-magnifier-glass");
        glass.setAttribute("id", "magnifying-glass-id-for-deleting");
        /*insert magnifier glass:*/
        dynamicImageRGB.parentNode.appendChild(glass);
        /*set background properties for the magnifier glass:*/
        glass.style.backgroundImage = "url('" + img.src + "')";
        glass.style.backgroundRepeat = "no-repeat";
        console.log(img.width + " " + img.height);
        glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
        bw = 3;
        w = glass.offsetWidth / 2;
        h = glass.offsetHeight / 2;

        /*execute a function when someone moves the magnifier glass over the image:*/
        glass.addEventListener("mousemove", moveMagnifier);
        allParent.addEventListener("mousemove", moveMagnifier);
        allParent.addEventListener("mouseleave", hideMagnifier);
        //img.addEventListener("mousemove", moveMagnifier);

        /*and also for touch screens:*/
        glass.addEventListener("touchmove", moveMagnifier);
        allParent.addEventListener("touchmove", moveMagnifier);
        allParent.addEventListener("touchend", hideMagnifier);
        //img.addEventListener("touchmove", moveMagnifier);
        
        glass.setAttribute("class", "img-magnifier-hide");
    }

    function hideMagnifier(){
        glass = document.getElementById("magnifying-glass-id-for-deleting");
        glass.setAttribute("class", "img-magnifier-hide");
    }

    function moveMagnifier(e) {
        var pos, x, y, w, h;
        let glass = document.getElementById("magnifying-glass-id-for-deleting");
        /*prevent any other actions that may occur when moving over the image*/
        e.preventDefault();
        /*get the cursor's x and y positions:*/
        pos = getCursorPos(e);
        x = pos.x;
        y = pos.y;
        w = glass.offsetWidth/2;
        h = glass.offsetHeight/2;
        bw = 3;
        zoom = document.getElementById("zoomRange").value/10;
        topOffset =  document.getElementById("dynamic-image-RGB").parentNode.getBoundingClientRect().top - document.getElementById("dynamic-slide").getBoundingClientRect().top;


        
        // check if Cursor is in the image
        if (x > img.width || x < 0 || y - topOffset > img.height || y < 0) {
            glass.setAttribute("class", "img-magnifier-hide");
            return
        } else {
            glass.setAttribute("class", "img-magnifier-glass");
        }
        

        // if the coursor is closer to the edge of the image than the glass is wide, the glass will not be moved in that direkction
        if (x < w) {
            glass.style.left = 0 + "px";
        } else if (x > img.width - w) {
            glass.style.left = img.width - w*2 + "px";
        } else {
            glass.style.left = (x - w) + "px";
        }

        //distance between 'my-dynamic-slide' and 'dynamic-image-RGB'

        if (y - topOffset < h) {
            glass.style.top = 0 + topOffset+ "px";
        } else if (y - topOffset > img.height - h) {
            glass.style.top = img.height + topOffset - h*2 + "px";
        } else {
            glass.style.top = (y - h) + "px";
        }

        //set the background position of the magnifier glass
        bgX = (x * zoom) - 2*w + bw;
        bgY = (y * zoom) - 2*h + bw;
        if(bgX < 0){
            bgX = 0;
        }
        if(bgY < 0){
            bgY = 0;
        }
        glass.style.backgroundPosition = "-" + bgX + "px -" + bgY + "px";

        //console.log("event at x: " + x + " y: " + y + "  / glass at x:" + glass.style.left + " y: " + glass.style.top);
    }
    
    function getCursorPos(e) {
        var a, x = 0, y = 0;
        e = e || window.event;
        /*get the x and y positions of the image:*/
        a = img.getBoundingClientRect();
        /*calculate the cursor's x and y coordinates, relative to the image:*/
        x = e.pageX - a.left;
        y = e.pageY - a.top;
        /*consider any page scrolling:*/
        x = x - window.pageXOffset;
        y = y - window.pageYOffset;
        return {x : x, y : y};
    }

    function demagnify() {
        glass = document.getElementById("magnifying-glass-id-for-deleting");
        img = document.getElementById("dynamic-slide").getElementsByTagName('img')[0];
        dynamicImageRGB = document.getElementById("dynamic-image-RGB");
        annotationCanvas = document.getElementById("dynamic-slide").getElementsByTagName('canvas')[0];
        allParent = dynamicImageRGB.parentNode.parentNode;
        if(glass){
            glass.parentNode.removeChild(glass);
            allParent.removeEventListener("mousemove", moveMagnifier);
            allParent.removeEventListener("touchmove", moveMagnifier);
            allParent.removeEventListener("mouseleave", hideMagnifier);
            allParent.removeEventListener("touchend", hideMagnifier);
        }
    }

    function remagnify() {
        if(magnifiying){
            zoomValue = document.getElementById("zoomRange").value/10;
            magnify(slideIndex, zoomValue);
        }
    }

    function openSettingsEvent(tablinkID, divName){
        tablink = document.getElementById(tablinkID);
        openSettings(tablink, divName);
    }

    function openSettings(selctedLink, divName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent-vertical");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablink-vertical");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(divName).style.display = "block";
      selctedLink.className += " active";
    }


    function getSlideIndexByFilename(filename, imagetype){
        var index = -1;
        for(var i = 0; i < slideshowCouples.length; i++){
            if(slideshowCouples[i][imagetype] == filename){
                index = i;
                break;
            }
        }
        return index;
    }

    function getSlideIndexByFilenameShort(filename, imagetype){
        var index = -1;
        for(var i = 0; i < slideshowCouples.length; i++){
            if(slideshowCouples[i][imagetype].includes(filename)){
                index = i;
                break;
            }
        }
        return index;
    }

    function getSlideByFilenameRGB(filename){
        var index = getSlideIndexByFilename(filename, 0);
        if(index != -1){
            var slide = document.getElementById("slide" + index);
            return slide;
        }
        return null;
    }

    function getSLideByFilenameIR(filename){
        var index = getSlideIndexByFilename(filename, 1);
        if(index != -1){
            var slide = document.getElementById("slide" + index);
            return slide;
        }
        return null;
    }

    function getFilenameBySlideIndex(index, imagetype){
        var path = slideshowCouples[index][imagetype];
        return path.substring(path.lastIndexOf('/')+1);
    }

    function getFilePathBySlideIndex(index, imagetype){
        var path = slideshowCouples[index][imagetype];
        return path;
    }


    function activateIRCanvas(){
        var canvasIRTest = document.getElementById('canvasIRTest');
        canvasIRTest.style.display = "block";
        //Remove all event listeners from canvas
        //var newCanvas = canvasIRTest.cloneNode(true);
        //canvasIRTest.parentNode.replaceChild(newCanvas, canvasIRTest);
        //canvasIRTest = newCanvas;

        
    }

    function deactivateIRCanvas(){
        var canvasIRTest = document.getElementById('canvasIRTest');
        canvasIRTest.style.display = "none";
    }

    function loadImagesMatrix(imageName) {
        infraredDataMatrix = allTemperaturesIR[slideIndex];

        if(infraredDataMatrix == null){
            $.post('/ir_temp_data_of_image/{{id}}', {filename: imageName}, function(response) {
                infraredDataMatrix = response.temperature_matrix;
                allTemperaturesIR[slideIndex] = infraredDataMatrix;
                drawImage();
            });
        } else {
            drawImage();
        }

        
    }



    // Function to draw the image based on the temperature range
    function drawImage() {
        console.log('redrawing ir of currentImageNameIRPath', currentImageNameIRPath);

        if (infraredDataMatrix == null) {
            console.log('infraredDataMatrix is null');
            return;
        }        

        //TODO gradient_lut_scheme imemr beim neu laden mit abspeichern
        if (numbr_at_end_of_value == gradient_lut_scheme){
            //TODO all in a seperate function
        }
        else{
            //TODO erst get, dann die selbe funktion aufrufen
        }


        $.get('/gradient_lut/'+numbr_at_end_of_value, function(lut) {
            gradient_lut = lut;

            let minTemp = parseInt(document.getElementById('fromSlider').value);
            let maxTemp = parseInt(document.getElementById('toSlider').value);
            lut_length = gradient_lut.length;

            let canvasIRTest = document.getElementById('canvasIRTest');
            let ctxIRTEst = canvasIRTest.getContext('2d');

            canvasIRTest.willReadFrequently = true;

            ctxIRTEst.clearRect(0, 0, canvasIRTest.width, canvasIRTest.height);

            //Set SIze of the canvas to the size of the image
            canvasIRTest.width = infraredDataMatrix[0].length;
            canvasIRTest.height = infraredDataMatrix.length;

            for (var y = 0; y < infraredDataMatrix.length; y++) {
                for (var x = 0; x < infraredDataMatrix[y].length; x++) {
                    var temperature = infraredDataMatrix[y][x];
                    if (temperature >= minTemp && temperature < maxTemp) {
                        var color = gradient_lut[Math.floor(((temperature - minTemp) / (maxTemp - minTemp)) * lut_length)];
                        ctxIRTEst.fillStyle = 'rgb(' + color[0] + ',' + color[1] + ',' + color[2] + ')';
                        ctxIRTEst.fillRect(x, y, 1, 1);
                    }
                    else {
                        //ctxIRTEst.fillStyle = 'rgba(0, 0, 0, 0)';
                        if(temperature < minTemp){
                            var color = gradient_lut[0];
                            ctxIRTEst.fillStyle = 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ', 0.45)';
                            ctxIRTEst.fillRect(x, y, 1, 1);
                        }
                        else{
                            var color = gradient_lut[gradient_lut.length - 1];
                            ctxIRTEst.fillStyle = 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ', 0.8)';
                            ctxIRTEst.fillRect(x, y, 1, 1);
                        }
                    }
                }
            }

            let debug = false;

            if(debug){
                //add timestemp on image
                ctxIRTEst.font = "20px Arial";
                ctxIRTEst.fillStyle = "white";
                ctxIRTEst.fillText("Time: " + currentImageNameIRPath.split('_')[1].split('.')[0], 10, 30);

                canvasIRTest.style.display = "block";

                //draw colors saved in the lut list over to bottom of the canvas with a height of 40px
                if (lut_length > 0) {
                    for (var i = 0; i < lut_length; i++) {
                        ctxIRTEst.fillStyle = 'rgb(' + gradient_lut[i][0] + ',' + gradient_lut[i][1] + ',' + gradient_lut[i][2] + ')';
                        ctxIRTEst.fillRect(i*2, canvasIRTest.height - 40, 2, 40);
                        if(i % (lut_length/10) <= 1){
                            ctxIRTEst.fillStyle = 'white';
                            ctxIRTEst.fillRect(i*2, canvasIRTest.height - 60, 2, 20);
                        }
                    }
                }
            }
        });
    }


    function activateIR() {
        openSettingsEvent('slideshow-settings-ir-tablink','slideshow-settings-IR')
        displayingIR = true;
        document.getElementById("dynamic-image-IR").style.zIndex = 0;

        if (magnifiying) {
            deactivateMagnifier();
        }
        if(displayingAI){
            deactivateAiOverlays();
        }

        showCurrentSlide(slideIndex);
    }

    function deactivateIR() {
        displayingIR = false;
        //set zIndex of ir-overlay to -1 
        document.getElementById("dynamic-image-IR").style.zIndex = -1;
        showCurrentSlide(slideIndex);

    }

    function activateMagnifier() {
        openSettingsEvent('slideshow-settings-magnifier-tablink', 'slideshow-settings-RGB')
        magnifiying = true;
        document.getElementById("dynamic-image-RGB").style.zIndex = 9;
        
        if (displayingIR){
            deactivateIR() 
        }
        if(displayingAI){
            deactivateAiOverlays();
        }

        //demagnify();
        magnify(slideIndex, document.getElementById("zoomRange").value/10);
    }

    function deactivateMagnifier() {
        magnifiying = false;
        document.getElementById("dynamic-image-RGB").style.zIndex = 0;
        demagnify();
    }

    function activateAiOverlays(){
        console.log("---activateAiOverlays---");
        openSettingsEvent('slideshow-settings-annotaions-tablink','slideshow-settings-Annotations')
        displayingAI = true;

        if(displayingIR){
            deactivateIR();
        }
        if(magnifiying){
            deactivateMagnifier();
        }

        toggleLayerSettings(false);
        showCurrentSlide();
        filenameOfSlide = getFilenameBySlideIndex(slideIndex,0);
        generateAnnotationsLayerTableForImage(filenameOfSlide);
    }

    function deactivateAiOverlays(){
        displayingAI = false;
        toggleLayerSettings(true);
        showCurrentSlide(slideIndex);
    }

    function color_closest(r,g,b){
        var min_distance = null
        var min_index = null
        for (const [i, c] of gradient_lut.entries()){
           var d = (r - c[0]) ** 2 + (g - c[1]) ** 2 + (b - c[2]) ** 2;
           if (min_distance == null || d < min_distance){
              min_distance = d;
              min_index = i;
           }
        }
        return min_index;
    }

    function calc_temp_from_percentage(perc){
        var maxT = Number(document.getElementById("maxTemp").value);
        var minT = Number(document.getElementById("minTemp").value);
        var degree = minT + ((maxT - minT) * perc);
        //console.log(perc, maxT, minT, degree, typeof minT)
        return Math.round( degree );
    }

    function getPosition(obj) {
        var curleft = 0,
        curtop = 0;
        if (obj.offsetParent) {
            do {
                curleft += obj.offsetLeft;
                curtop += obj.offsetTop;
            } while (obj = obj.offsetParent);
            return {
                x: curleft,
                y: curtop
            };
        }
        return undefined;
    }

    function rgbToHex(r, g, b) {
        if (r > 255 || g > 255 || b > 255)
            throw "Invalid color component";
        return ((r << 16) | (g << 8) | b).toString(16);
    }

    function rgbaToHex(r, g, b, a) {
        if (r > 255 || g > 255 || b > 255 || a > 255)
            throw "Invalid color component";
        return ((r << 24) | (g << 16) | (b << 8) | a).toString(24);
    }


        function resizeCanvas(){
        //get all objects with class "annotaionsCanvas"
        var canvases = document.getElementsByClassName("annotaionsCanvas");
        var img = document.getElementById("dynamic-image-RGB").getElementsByTagName("img")[0];


        for (var i = 0; i < canvases.length; i++) {
            var canvas = canvases[i];
            canvas.width = img.width;
            canvas.height = img.height;

            let body_width = document.getElementsByClassName("container")[0].offsetWidth;
            dynamicAnnotationsCanvas.setWidth(body_width);
            dynamicAnnotationsCanvas.setHeight(imgA.height * ( body_width/ imgA.width));
        }

        if (displayingAI){
            drawAnnotationsOnCurrentSlide();
        }
    }

</script>
</head>
<body>
<details id="gallery-details">
    <summary>Photo Gallery </summary>
    <div style="width: 100%;">
        <div id="slideshow-container">
            <a class="prev" onclick="plusSlides(-1)">❮</a>
            <a class="next" onclick="plusSlides(1)">❯</a>
            {% if slide_file_paths %}
            <div class="mySlides" id="dynamic-slide">
                <a id="dynamic-filename-RGB" style="display: inline-block; padding: 8px 0"> RGB: x.jpeg</a>
                <a id="dynamic-filename-IR" style="display: inline-block; padding: 8px 0"> IR: x.jpeg</a>
                <a id="dynamic-filename-Unprocessed" style="display: inline-block; padding: 8px 0"> Unprocessed: </a>
                <div class="usedInMappingContainer">
                    <div class="usedInMapping">
                        <a style="margin: 0 6px; float: left">&#10003</a>
                        <a style="margin: auto">Used in map</a>
                    </div>
                    <div class="notUsedInMapping">
                        <a style="margin: 0 6px; float: left">&#9888;</a>
                        <a style="margin: auto">Not used in map</a>
                    </div>
                </div>
                <div style="display: grid;place-items: center;grid-template-areas: 'inner-div'; width: 100%; grid-template-columns: minmax(100px, 1fr);">
                    <div style="grid-area: inner-div;">
                        <a id="dynamic-image-RGB">
                            <img src="{{ url_for('static', filename='default/missingCounterpartRGB.JPG') }}" loading="lazy" style="width:100%; height: 100%; opacity: 50%">
                        </a>
                    </div>
                    <div style="grid-area: inner-div;">
                        <a>
                            <canvas id="dynamic-canvas" class="annotaionsCanvas" width="100%" height="100%;"></canvas>
                        </a>
                    </div>


                    <div class="ir-overlay" style="width: 80%; opacity: 0; grid-area: inner-div;" id="dynamic-image-IR">
                        <img class="ir-image" src="{{ url_for('static', filename='default/missingCounterpartIR.JPG') }}">
                        <canvas id="canvasIRTest" width="500" height="500" style="width: 100%; display: none"></canvas>
                        <div class="temp-glass" id="dynamic-temp-glass"> <p>Temp:</p></div>
                    </div>
                </div>
            </div>
        </div>
            {% endif %}
    </div>
        <div id="slideshow-settings-tabs">
            <div id="slideshow-settings-tabs-links" class="tab-vertical">
                <button id="slideshow-settings-magnifier-tablink" class="tablink-vertical" onclick="activateMagnifier()">Magnifier</button>
                {% if has_ir %}
                <button id="slideshow-settings-ir-tablink" class="tablink-vertical" onclick="activateIR()">IR-Overlay</button>
                {% endif %}
                {% if detections %}
                <button id="slideshow-settings-annotaions-tablink" class="tablink-vertical" onclick="activateAiOverlays()">AI-Overlays</button>
                {% endif %}
            </div>

            <div id="slideshow-settings-RGB" class="tabcontent-vertical">
                <div class="slideshow-settings-item">

                    <div style="grid-area: a0;">
                         <label for="zoomRange" >Zoom: <span id="zoomValue"></span></label>
                    </div>
                    <div style="grid-area: a1;">
                        <input type="range" min="10" max="100" value="50" class="slider" id="zoomRange" style="width:100%;">
                    </div>

                </div>
            </div>
            <div id="slideshow-settings-IR" class="tabcontent-vertical">
                <div class="slideshow-settings-item">
                    
                    <div class="" style="grid-area: a0;">
                        <label for="irOpacityRange" >Opacity: <span id="opacityValue"></span></label>
                    </div>
                    <div class="" style="grid-area: a1;">
                        <input type="range" min="10" max="100" value="100" class="slider" id="irOpacityRange" style="width:100%; grid-area: center">
                    </div>

                    
                    <div class="slideshow-settings-inside-contianer" style="grid-area: c0;">
                        <div style="margin: auto; padding-bottom: 12px; padding-top:12px; margin: auto; width: 180px;">
                            <label>
                                <label class="switch">
                                    <input type="checkbox" id="irModeCheckbox" >
                                    <span class="switch-slider round"></span>
                                </label>
                            Ir Analysis Mode
                            </label>
                        </div>
                        <div style="background: var(--bg-color-AILayer); padding: 12px 16px;">
                            <div class="setting-fade" style="width: 80%; max-width: 260px; margin-left: auto;">
                                <select id="ir-palette-chooser-display" class="setting-disabler" style="width: 100%">
                                    <option value="grad-option1">white hot</option>
                                    <option value="grad-option2">Fulgurite</option>
                                    <option value="grad-option3">Iron Red</option>
                                    <option value="grad-option4">Hot Iron</option>
                                    <option value="grad-option5">Medical</option>
                                    <option value="grad-option6">Arctic</option>
                                    <option value="grad-option7">Rainbow 1</option>
                                    <option value="grad-option8">Rainbow 2</option>
                                    <option value="grad-option9">Tint</option>
                                    <option value="grad-option10">Black Hot</option>
                                </select>
                            </div>

                            <div class="setting-fade range_container" style="width= 100%;">
                                <div class="sliders_control">
                                    <input id="fromSlider" class="setting-disabler" type="range" value="{{ir_settings.ir_min_temp }}" min="-20" max="180"/>
                                    <input id="toSlider" class="setting-disabler" type="range" value="{{ir_settings.ir_max_temp }}" min="-20" max="180"/>
                                    <output class="bubble" id="fromBubble"></output>
                                    <output class="bubble" id="toBubble"></output>
                                    <div id="gradientInSlider" style="z-index: 2; height: 20px; position: relative; top: 2px;"></div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="slideshow-settings-Annotations" class="tabcontent-vertical">
                <div class="slideshow-settings-item-unstructured">
                    <div style="display: flex; align-items: baseline;">
                        Annotations line width:
                        <input type="number" id="annotationsLineWidth" name="lineWidth" min="1" max="100" value="2"
                               style="width: 60px; margin: 0 6px; border: 0px; border-radius: 4px; padding: 4px">
                        <div style="width: 2px; margin: auto"></div>
                        <select id="addAnnotationDropdown" style="width: min(80px, 15%); margin: 0 8px; padding: 2px; border-radius: 4px;">
                            <option>placeholder</select>
                        <input class="big_button" style="float: right;height: auto;margin: 0 0 10px;" type="button" value="Add Detection" onclick="addDetection()">
                    </div>
                    <div id="layer-table-container">
                        <table>
                            <tbody>
                            <tr>
                                <th colspan="1">Layer</th>
                                <td colspan="1">total found objects</td>
                                <td colspan="1">displayed objects</td>
                                <td colspan="2">threshold</td>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
</details>

{% if panos %}
<details id="panoDetails">
    <summary>Panorama Viewer</summary>
    <div class="tab-content">
        {% include 'panoViewer.html' %}
    </div>
</details>
{% endif %}

<div class="container">

    <ul class="tabs">
        {% if has_rgb %}
        <li id="tab-link-1" class="tab-link current" data-tab="tab-1">RGB Photos</li>
        {% endif %}

        {% if has_ir %}
        {% if not has_rgb %}
        <li id="tab-link-2" class="tab-link current" data-tab="tab-2"> IR Photos</li>
        {% else %}
        <li id="tab-link-2" class="tab-link" data-tab="tab-2"> IR Photos</li>
        {% endif %}
        {% endif %}

        {% if panos %}
        {% if not has_rgb and not has_ir%}
        <li id="tab-link-3" class="tab-link current" data-tab="tab-3">Panoramas</li>
        {% else %}
        <li id="tab-link-3" class="tab-link" data-tab="tab-3">Panoramas</li>
        {% endif %}
        {% endif %}

        {%  if unprocessed_images %}
        {% if not has_rgb and not has_ir and not panos %}
        <li id="tab-link-4" class="tab-link current" data-tab="tab-4">Unprocessed</li>
        {% else %}
        <li id="tab-link-4" class="tab-link" data-tab="tab-4">Unprocessed</li>
        {% endif %}
        {% endif %}
    </ul>

    {% if has_rgb %}
    <div id="tab-1" class="tab-content_gallery current">
    {% else %}
    <div id="tab-1" class="tab-content_gallery">
    {% endif %}
        {% if slide_file_paths %}
        {% for couple in slide_file_paths %}
        {% if couple[0] != "" %}
        <div style="float:left;width:20%; min-width:240px;">
            <img id="galleryImage{{ couple[0].split('/')[-1] }}" src="{{ global_for(thumbnail_for(couple[0])) }}" loading="lazy" style="padding: 5px;width:95%;cursor: pointer;" onclick="showSlideByFilename('{{ couple[0] }}')">
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>
    {% if not has_rgb and has_ir%}
    <div id="tab-2" class="tab-content_gallery current">
    {% else %}
    <div id="tab-2" class="tab-content_gallery">
    {% endif %}
        <div style="width: 100%; height: 100%; overflow: auto;">
            {% if slide_file_paths %}
            {% for couple in slide_file_paths %}
            {% if couple[1] != "" %}
            <div style="float:left;width:20%; min-width:240px;">
                <img src="{{ global_for(thumbnail_for(couple[1])) }}" style="padding: 5px;width:95%;cursor: pointer;" onclick="showSlideByFilename('{{ couple[1] }}')">
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% if not has_rgb and not has_ir and panos%}
    <div id="tab-3" class="tab-content_gallery current">
    {% else %}
    <div id="tab-3" class="tab-content_gallery">
    {% endif %}
        <div style="width: 100%; height: 100%; overflow: auto;">
            {% if panos %}
            {% for pano in panos %}
            <div style="float:left;width:20%; min-width:240px;">
                <img src="{{ global_for(thumbnail_for(pano.file)) }}" style="padding: 5px;width:95%;cursor: pointer;" onclick="show_pano({{ loop.index0 }})">
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% if not has_rgb and not has_ir and not panos and unprocessed_images%}
    <div id="tab-4" class="tab-content_gallery current">
    {% else %}
    <div id="tab-4" class="tab-content_gallery">
    {% endif %}
        <div style="width: 100%; height: 100%; overflow: auto;">
            {% if slide_file_paths %}
            {% for couple in slide_file_paths %}
            {% if couple[2]%}
            <div style="float:left;width:20%; min-width:240px;">
                <img src="{{ global_for(couple[2]) }}" style="padding: 5px;width:95%;cursor: pointer;" onclick="showSlideByFilename('{{ couple[2] }}')">
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>

</div>
{%include 'detectionPopup.html'%}
{%include 'popupEditDetectionType.html'%}


<script>
    var slideshowCouples = {{ slide_file_paths|tojson }};
    {% if has_ir %}
    var gradient_lut = {{ gradient_lut }};
    var gradient_lut_scheme = {{ ir_settings.ir_color_scheme }};
    {% else %}
    var gradient_lut = null;
    var gradient_lut_scheme = null;
    {% endif %}
    var displayingIR = false;
    var displayingAI = false;
    var magnifiying = true;
    remagnify();
    var lastSlide = 0;
    var allImages = [];
    var allTemperaturesIR = [];
    var slideIndex = 0;
    var infraredDataMatrix = null;
    const dynamicAnnotationsCanvas = new fabric.Canvas('dynamic-canvas', {
        selection: false,
        backgroundColor: 'rgba(0,0,0,0)',
        interactive: true
    });
    dynamicAnnotationsCanvas.hoverCursor = 'pointer';
    fabric.Object.prototype.cornerStyle = 'circle';//default rect
    fabric.Object.prototype.setControlsVisibility({
        mt: true,
        mb: true,
        ml: true,
        mr: true,
        bl: true,
        br: true,
        tl: true,
        tr: true,
        mtr: false,
    });

    dynamicAnnotationsCanvas.on('mouse:down', function(options) {
        if (! options.target) {
            unselectAnnotations();    
        }
    });

    for (var i = 0; i < slideshowCouples.length; i++) {
        if (slideshowCouples[i][0] != "" ) {
            slideIndex = i;
            break;
        }
    }

    for(var i = 0; i < slideshowCouples.length; i++){
        var imagePlacerholders = [];
        for(var j = 0; j < slideshowCouples[i].length; j++){
            imagePlacerholders.push(null);
        }
        allImages.push(imagePlacerholders);
        allTemperaturesIR.push(null);
    }
        
    var currentImageName = slideshowCouples[slideIndex][0].substring(slideshowCouples[slideIndex][0].lastIndexOf('/') + 1);
    var currentImageNameIRPath = slideshowCouples[slideIndex][1];
    var infraredData = [];

    var ImageRGB_missingCounterpart = new Image();
    ImageRGB_missingCounterpart.src = "{{ url_for('static', filename='default/missingCounterpartRGB.JPG') }}";
    ImageRGB_missingCounterpart.className = "dynamic-images-rgb";
    var ImageIR_missingCounterpart = new Image()
    ImageIR_missingCounterpart.src = "{{ url_for('static', filename='default/missingCounterpartIR.JPG') }}";
    ImageIR_missingCounterpart.className = "ir-image";


    showCurrentSlide(slideIndex);
    
    var slideshowContainer = document.getElementById("slideshow-container");
    var dynamicSlide = document.getElementById("dynamic-slide");
    dynamicSlide.style.display = "block";


    var slider = document.getElementById("zoomRange");
    var output = document.getElementById("zoomValue");
    output.innerHTML = slider.value/10;


    document.getElementById("dynamic-slide").getElementsByTagName('img')[0].onload = function(){
        magnify(0,slider.value/10);
    }

    slider.oninput = function() {
        output.innerHTML = this.value/10;
        demagnify();
        if(magnifiying){
            magnify(slideIndex, this.value/10);
      }
    }

    $('#irModeCheckbox').change(function(){
        if(this.checked){
            $('.setting-fade').map(function () {
            $(this).css("opacity", "0.999");
            });
            $('.setting-disabler').map(function () {
                $(this).prop('disabled', false);
            });
        } else {
            document.getElementById('dynamic-temp-glass').style.opacity = 0;
            $('.setting-fade').map(function () {
            $(this).css("opacity", "0.4");
            });
            $('.setting-disabler').map(function () {
                $(this).prop('disabled', true);
            });
        }
        showCurrentSlideIR();
    });




    $(document).ready(function(){
        $('ul.tabs li').click(function(){
            var tab_id = $(this).attr('data-tab');

            $('ul.tabs li').removeClass('current');
            $('.tab-content_gallery').removeClass('current');

            $(this).addClass('current');
            $("#"+tab_id).addClass('current');
        })


        $('#annotationsLineWidth').change(function(event) {
            if(displayingAI){
                drawAnnotationsOnCurrentSlide();
            }
        });


    })





    {% if has_ir %}


    $('#irOpacityRange').on('input', function(event) {
        irOpacity = $(this).val()/100;
        applyOpacity(irOpacity);
        opacityValue = document.querySelector('#opacityValue');
        opacityValue.innerHTML = irOpacity;
    });


    //$('#irOverlayCheckbox').prop('checked', false);
    //$('#magnifierCheckbox').prop('checked', true);
    $('.setting-fade').map(function () {
        $(this).css("opacity", "0.4");
    });
    $('.setting-disabler').map(function () {
        $(this).prop('disabled', true);
    });


    $('#irOpacityRange').val(100);
    $('#irOpacityRange').change();

    //change css class of grad depending on selected option of ir-palette-chooser
    $("#ir-palette-chooser-display").change(function() {

        var ir_palette = $(this).val();
        console.log(ir_palette);
        numbr_at_end_of_value = ir_palette.match(/\d+$/);

        gradientDiv = document.getElementById('gradientInSlider');
        //remove all classes from the div
        gradientDiv.className = '';
        gradientDiv.classList.add('grad-option'+numbr_at_end_of_value);

        $("#ir-palette-chooser-display option:selected").each(function() {
            
            drawGradientInMiddleOfSlider(document.getElementById('fromSlider'), document.getElementById('toSlider'));
            $.get('/gradient_lut/'+numbr_at_end_of_value, function(lut) {
                console.log(lut);
                gradient_lut = lut;
                drawImage();
            });
        });
    });


    $("#ir-palette-chooser-display").val("grad-option{{ ir_settings.ir_color_scheme }}").change();



    function controlFromSlider(fromSlider, toSlider) {
        const [from, to] = getParsed(fromSlider, toSlider);
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
        if (from > to) {
            fromSlider.value = to;
        } 
        bubble = document.getElementById('fromBubble');
        setBubble(fromSlider, bubble);
    }

    function controlToSlider(fromSlider, toSlider) {
        const [from, to] = getParsed(fromSlider, toSlider);
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
        //setToggleAccessible(toSlider);
        if (from <= to) {
            toSlider.value = to;
        } else {
            toSlider.value = from;
        }
        bubble = document.getElementById('toBubble');
        setBubble(toSlider, bubble);
    }

    function getParsed(currentFrom, currentTo) {
        const from = parseInt(currentFrom.value, 10);
        const to = parseInt(currentTo.value, 10);
        return [from, to];
    }

    function fillSlider(from, to, sliderColor, rangeColor, controlSlider) {
        const rangeDistance = to.max-to.min;
        const fromPosition = from.value - to.min;
        const toPosition = to.value - to.min;
        controlSlider.style.background = `linear-gradient(
        to right,
        ${sliderColor} 0%,
        ${sliderColor} ${(fromPosition)/(rangeDistance)*100}%,
        ${'transparent'} ${((fromPosition)/(rangeDistance))*100}%,
        ${'transparent'} ${(toPosition)/(rangeDistance)*100}%, 
        ${sliderColor} ${(toPosition)/(rangeDistance)*100}%, 
        ${sliderColor} 100%)`;
        drawGradientInMiddleOfSlider(from, to);
    }

    function drawGradientInMiddleOfSlider(fromSlider, toSlider){
        gradientDiv = document.getElementById('gradientInSlider');
        const rangeDistance = toSlider.max-toSlider.min;
        const fromPosition = fromSlider.value - toSlider.min;
        const toPosition = toSlider.value - toSlider.min;
        
        //position div in middle of slider
        gradientDiv.style.left = ((fromPosition)/(rangeDistance)*100 +1)  + "%";
        gradientDiv.style.width = ((toPosition - fromPosition)/(rangeDistance)*100 - 1) + "%";

    }

    function setBubble(range, bubble) {
        const val = range.value;
        const min = range.min ? range.min : 0;
        const max = range.max ? range.max : 100;
        const newVal = Number(((val - min) * 100) / (max - min));
        bubble.innerHTML = val + "°C";

        // Sorta magic numbers based on size of the native UI thumb
        bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
    }

    function setToggleAccessible(currentTarget) {
        const toSlider = document.querySelector('#toSlider');
        if (Number(currentTarget.value) <= 0 ) {
            toSlider.style.zIndex = 4;
        } else {
            toSlider.style.zIndex = 3;
        }
    }

    const fromSlider = document.querySelector('#fromSlider');
    const toSlider = document.querySelector('#toSlider');
    fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
    setToggleAccessible(toSlider);
    setBubble(fromSlider, document.getElementById('fromBubble'));
    setBubble(toSlider, document.getElementById('toBubble'));

    fromSlider.oninput = () => controlFromSlider(fromSlider, toSlider);
    toSlider.oninput = () => controlToSlider(fromSlider, toSlider);
    toSlider.addEventListener('change', () => drawImage());
    fromSlider.addEventListener('change', () => drawImage());





    document.getElementById('canvasIRTest').addEventListener("mousemove", function(e) {
        if($('#irModeCheckbox').is(':checked')){
            var tempMatrix = allTemperaturesIR[slideIndex];
            var tempGlass = document.getElementById('dynamic-temp-glass');
            tempGlass.style.opacity = 1.0;
            matrix_coord_x = Math.floor(e.offsetX / this.clientWidth * tempMatrix[0].length);
            matrix_coord_y = Math.floor(e.offsetY / this.clientHeight * tempMatrix.length);
            
            var p = this.getContext('2d').getImageData(matrix_coord_x, matrix_coord_y, 1, 1).data;
            var coord = "x: " + e.offsetX + " ,y: " + e.offsetY;
            // If transparency on the image
            if ((p[0] == 0) && (p[1] == 0) && (p[2] == 0) && (p[3] == 0)) {
                coord += " (Transparent color detected, cannot be converted to HEX)";
            }
            var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
            var temp = tempMatrix[matrix_coord_y][matrix_coord_x];
            //round to one decimal
            temp = Math.round(temp * 10) / 10;
            tempGlass.style.backgroundColor = hex;
            tempGlass.innerHTML = " " +temp + "°C  ";

            $('#dynamic-temp-glass').css({
                left: e.offsetX + 20 + this.offsetLeft,
                top: e.offsetY + document.body.scrollTop + this.offsetTop,
            });
            if ((p[0]*0.299 + p[1]*0.587 + p[3]*0.114) > 186){
                tempGlass.style.color = "#000000";
                tempGlass.style.borderColor = "#000000";
            } else {
                tempGlass.style.color = "#ffffff";
                tempGlass.style.borderColor = "#ffffff";
            }
        } else {
            var tempGlass = document.getElementById('dynamic-temp-glass');
            tempGlass.style.opacity = 0.0;
            this.style.backgroundColor = "transparent";
            this.innerHTML = "";
        }
    });

    document.getElementById('canvasIRTest').addEventListener("mouseleave", function(e) {
        var tempGlass = document.getElementById('dynamic-temp-glass');
        tempGlass.style.opacity = 0.0;
        this.style.backgroundColor = "transparent";
        this.innerHTML = "";
    });

    {% endif %}        


    window.onload = function() {
        {% if detections %}
        generateDetectionTable({{ detections | tojson }});
        $('#initialDetectionsLoading').hide();
        generateAnnotationSettings({{ detections | tojson }});
        var fileName = "{{ file_names[0].split('/')[-1] }}";
        generateAnnotationsLayerTableForImage(fileName);
        //$('#aiOverlayCheckbox').prop('checked', false);
        toggleLayerSettings(true);
        {% endif %}
    };

    {% if slide_file_paths %}
    {% if slide_file_paths[0][0] != "" %}

    var dynamicCanvas = document.getElementById('dynamic-canvas');

    context = dynamicCanvas.getContext('2d');
    var imgA = new Image();
    imgA.src = "{{ global_for(slide_file_paths[0][0]) }}";
    imgA.onload = () => {
        //width of div of class container
        var body_width = document.getElementsByClassName("container")[0].offsetWidth;
        //dynamicCanvas.width = body_width;
        //dynamicCanvas.height = imgA.height * ( body_width/ imgA.width);
        dynamicAnnotationsCanvas.setWidth(body_width);
        dynamicAnnotationsCanvas.setHeight(imgA.height * ( body_width/ imgA.width));
    };

    {% endif %}
    {% endif %}



    document.getElementById("slideshow-settings-magnifier-tablink").click();


</script>
</body>
</html>
